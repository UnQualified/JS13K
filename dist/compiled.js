function game(){function e(){if(t(),n.textAlign="left",n.fillText(f.gameState,l.width-200,20),n.fillText("player 1: "+f.playerOneHealth,10,l.height-50),n.fillText("player 2: "+f.playerTwoHealth,l.width-200,l.height-50),"toss"===f.gameState)if(o.getScore()<k&&g.getScore()<k)o.draw(n),g.draw(n);else{var a="";120>d?(d++,a=o.getScore()>=k?"player one":"player two",f.tossWinner=o.getScore()>=k?1:2,a+=" has the power"):240>d?(a="choose your attack",d++):a=null,n.textAlign="center",null!==a?n.fillText(a,r().x,r().y):f.gameState="attackSelection"}else if("attackSelection"==f.gameState)y.displayAttacks(r()),y.selectedAttack(h),d=0;else if("attack"==f.gameState){n.textAlign="center";var i="player "+f.tossWinner+" does a "+f.chosenAttack.type+" attack";n.fillText(i,r().x,r().y),d++,d>=120&&(f.gameState="defense",d=0)}else if("defense"==f.gameState)n.textAlign="center",f.defender=1===f.tossWinner?2:1,n.fillText("player "+f.defender+", reverse it!",r().x,r().y),d++,d>=120&&(d=0,f.gameState="attackIncoming",o.resetScore(),g.resetScore());else if("attackIncoming"==f.gameState){d++;var c=60/f.chosenAttack.speed*10;switch(n.textAlign="center",n.fillText(c+" : "+d,r().x,l.height-50),f.defender){case 1:o.draw(n),o.getScore()>=100&&(f.gameState="attackFail");break;case 2:g.draw(n),g.getScore()>=100&&(f.gameState="attackFail")}d>=c&&(f.gameState="attackSuccess")}else if("attackFail"==f.gameState)o.resetScore(),g.resetScore(),d=0,1===f.defender?(f.playerTwoHealth-=f.chosenAttack.damage/2,f.playerTwoHealth<=0?(f.playerTwoHealth=0,f.gameState="gameOver"):f.gameState="toss"):(f.playerOneHealth-=f.chosenAttack.damage/2,f.playerOneHealth<=0?(f.playerOneHealth=0,f.gameState="gameOver"):f.gameState="toss");else if("attackSuccess"==f.gameState){if(1===f.defender){if(f.playerOneHealth-=f.chosenAttack.damage,f.playerOneHealth<=0)return console.log("gameOver"),f.playerOneHealth=0,f.gameState="gameOver",void(d=0)}else if(f.playerTwoHealth-=f.chosenAttack.damage,f.playerTwoHealth<=0)return console.log("gameOver"),f.playerTwoHealth=0,f.gameState="gameOver",void(d=0);f.gameState="toss",d=0,o.resetScore(),g.resetScore()}else if("gameOver"==f.gameState){console.log("gameOver state achieved");var s=f.playerOneHealth<=0?"Player 2":"Player 1";s+=" wins",n.textAlign="center",n.fillText(s,r().x,r().y),d++,d>=120&&(d=0,f.gameState="toss",f.playerOneHealth=f.playerTwoHealth=100)}window.requestAnimationFrame(e)}function t(){n.clearRect(0,0,l.width,l.height)}function a(e,t,a){var r=0;return n.font="22px sans-serif",{draw:function(){n.fillText(a.getLetter(),e,t),n.fillText(r,e,t+50)},getScore:function(){return r},updateScore:function(e){r+=e},resetScore:function(){r=0}}}function r(){return{x:l.width/2,y:l.height/2}}var l=document.getElementById("canvas"),n=l.getContext("2d");l.width=800,l.height=400;var i=new AvailableKeys,c=new KeyStroke(i.getKey()),s=new KeyStroke(i.getKey()),o=a(10,20,c),g=a(100,20,s),y=new Attack(n),h=null,d=0,f={gameState:"toss",attackingPlayer:null,playerOneHealth:100,playerTwoHealth:100,tossWinner:null,chosenAttack:null,defender:null},k=10,p={water:{type:"water",speed:2,damage:30},fire:{type:"fire",speed:1,damage:40},electric:{type:"electric",speed:3,damage:15},special:{type:"special",speed:2,damage:50}};window.requestAnimationFrame(e),window.addEventListener("keydown",function(e){if("toss"===f.gameState)e.keyCode===c.currentLetter?(i.keys[c.currentLetter-65].available=!0,c.assignLetter(i.getKey()),o.updateScore(10)):e.keyCode===s.currentLetter&&(i.keys[s.currentLetter-65].avaialble=!0,s.assignLetter(i.getKey()),g.updateScore(10));else if("attackIncoming"===f.gameState)e.keyCode===c.currentLetter?(i.keys[c.currentLetter-65].available=!0,c.assignLetter(i.getKey()),o.updateScore(20)):e.keyCode===s.currentLetter&&(i.keys[s.currentLetter-65].available=!0,s.assignLetter(i.getKey()),g.updateScore(20));else if("attackSelection"===f.gameState&&y.available)switch(e.keyCode){case 87:h="water",y.available=!1,f.gameState="attack",f.chosenAttack=p.water;break;case 70:h="fire",y.available=!1,f.gameState="attack",f.chosenAttack=p.fire;break;case 69:h="electric",y.available=!1,f.gameState="attack",f.chosenAttack=p.electric;break;case 83:h="special",y.available=!1,f.gameState="attack",f.chosenAttack=p.special}})}function rnd(e,t){return Math.floor(Math.random()*(t-e+1))+e}function KeyStroke(e){this.currentLetter=e}function AvailableKeys(){this.keys=[];for(var e=65;91>e;e++)this.keys.push({key:e,available:!0})}function Attack(e){this.ctx=e,this.available=!1}KeyStroke.prototype.assignLetter=function(e){this.currentLetter=e},KeyStroke.prototype.getLetter=function(){return String.fromCharCode(this.currentLetter).toUpperCase()},KeyStroke.prototype.getRandom=function(e,t){return Math.floor(Math.random()*(t-e+1))+e},AvailableKeys.prototype.getKey=function(){var e=rnd(0,this.keys.length-1),t=this.keys[e];return t.available?(this.keys[e].available=!1,t.key):this.getKey()},Attack.prototype.displayAttacks=function(e){this.available=!0,this.ctx.fillText("fire",e.x-100,e.y),this.ctx.fillText("water",e.x,e.y-100),this.ctx.fillText("electric",e.x+100,e.y),this.ctx.fillText("special",e.x,e.y+100)},Attack.prototype.selectedAttack=function(e){this.available&&(this.ctx.textAlign="left",this.ctx.fillText(e+" selected",20,100))};