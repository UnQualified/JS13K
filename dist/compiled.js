function game(){function t(){if(e(),l(),m.ball.update(),n.fillStyle="black","menu"===v.state)r(o.toUpperCase(),c.x,c.y-50,"center","52px"),r("press [space]",c.x,c.y+20,"center");else if("intro"===v.state)r("INTRO",c.x,c.y+100,"center"),m.g.reduceOffset(k.fast),m.w.reduceOffset(k.fast),console.log(m.w.y),m.ps1.reduceOffset(k.fast),m.ps2.reduceOffset(k.fast),v.start&&(v.state="toss");else if("toss"===v.state)if(f.getScore()<S&&p.getScore()<S)f.draw(n),p.draw(n);else{var a="";120>w?(w++,a=f.getScore()>=S?"player one":"player two",v.tossWinner=f.getScore()>=S?1:2,m.ball.setPlayer(v.tossWinner),a+=" has the power"):240>w?(a="choose your attack",w++):a=null,null!==a?r(a,c.x,c.y,"center"):v.state="attackSelection"}else if("attackSelection"==v.state)g.displayAttacks(c),s();else if("attack"==v.state){m.ball.setAttack(v.chosenAttack);var i="player "+v.tossWinner+" does a "+v.chosenAttack.type+" attack";r(i,c.x,c.y,"center"),w++,w>=120&&s({state:"defense"})}else if("defense"==v.state)v.defender=1===v.tossWinner?2:1,r("player "+v.defender+", reverse it!!",c.x,c.y,"center"),w++,w>=120&&s({state:"attackIncoming"});else if("attackIncoming"==v.state){w++;var d=60/v.chosenAttack.speed*10;switch(r(d+" : "+w,c.x,h.height-50,"center"),m.ball.speed=575/(d/10)/10,m.ball.show=!0,v.defender){case 1:f.draw(n),f.getScore()>=100&&(v.state="attackFail");break;case 2:p.draw(n),p.getScore()>=100&&(v.state="attackFail")}w>=d&&(v.state="attackSuccess")}else if("attackFail"==v.state)s(),m.ball.show=!1,1===v.defender?(v.playerTwoHealth-=v.chosenAttack.damage/2,m.ps2.health=v.playerTwoHealth,v.playerTwoHealth<=0?(v.playerTwoHealth=0,m.ps2.health=v.playerTwoHealth,s({state:"gameOver"})):v.state="toss"):(v.playerOneHealth-=v.chosenAttack.damage/2,m.ps1.health=v.playerOneHealth,v.playerOneHealth<=0?(v.playerOneHealth=0,m.ps1.health=v.playerOneHealth,v.state="gameOver"):v.state="toss");else if("attackSuccess"==v.state){m.ball.show=!1;var y=!0;1===v.defender?(v.playerOneHealth-=v.chosenAttack.damage,m.ps1.health=v.playerOneHealth,v.playerOneHealth<=0&&(v.playerOneHealth=0,m.ps1.health=v.playerOneHealth,v.state="gameOver",w=0,y=!1)):(v.playerTwoHealth-=v.chosenAttack.damage,m.ps2.health=v.playerTwoHealth,v.playerTwoHealth<=0&&(v.playerTwoHealth=0,m.ps2.health=v.playerTwoHealth,v.state="gameOver",w=0,y=!1)),y&&s({state:"toss"})}else if("gameOver"==v.state){var u=v.playerOneHealth<=0?"Player 2":"Player 1";u+=" wins",r(u,c.x,c.y,"center"),w++,w>=120&&(v.start=!1,s({state:"menu",health:!0}))}window.requestAnimationFrame(t)}function e(){n.clearRect(0,0,h.width,h.height)}function a(t,e,a){var i=0;return{draw:function(){n.lineWidth=3,n.strokeStyle="black",r(a.getLetter(),t,e,"center","400px","rgba(255,255,255,0.8)"),n.strokeText(a.getLetter(),t,e),n.lineWidth=0},getScore:function(){return i},updateScore:function(t){i+=t},resetScore:function(){i=0}}}function i(){return{x:h.width/2,y:h.height/2}}function s(t){w=0,f.resetScore(),p.resetScore(),void 0!==t&&(void 0!==t.health&&(v.playerOneHealth=v.playerTwoHealth=b),void 0!==t.state&&(v.state=t.state))}function r(t,e,a,i,s,r){void 0!==i&&(n.textAlign=i),void 0===r?(n.fillStyle="rgb(255,255,255)",n.shadowColor="white"):(n.fillStyle=r,n.shadowColor=r),n.font=(void 0===s?"22px":s)+" sans-serif",n.shadowBlur=10,n.fillText(t,e,a),n.shadowBlur=0}function l(){m.stars.forEach(function(t){t.draw()}),m.ball.draw(),m.ball.drawReflection(),m.m.draw(),m.g.draw(),m.ps1.draw(),m.ps1.drawReflection(),m.ps2.draw(),m.ps2.drawReflection(),m.w.draw()}var o="The Odul Mages",h=document.getElementById("canvas"),n=h.getContext("2d");h.width=960,h.height=540;var c=i(),d=new AvailableKeys,y=new KeyStroke(d.getKey()),u=new KeyStroke(d.getKey()),f=a(240,h.height/2+100,y),p=a(720,h.height/2+100,u),g=new Attack(n),w=0,x=1.25*h.height,k={fast:2,med:.2,slow:.1},v={state:"menu",attackingPlayer:null,playerOneHealth:100,playerTwoHealth:100,tossWinner:null,chosenAttack:null,defender:null,start:!1},b=100,S=50,T={water:{type:"water",speed:2,damage:30,colour:"rgb(0,0,255)"},fire:{type:"fire",speed:1,damage:40,colour:"rgb(255,0,0)"},electric:{type:"electric",speed:3,damage:15,colour:"rgb(255,255,0)"},special:{type:"special",speed:2,damage:50,colour:"rbg(255,0,255)"}},m={stars:starField(n,30),ball:attackBall(n,180,290,40,5,1),g:ground(n,0,370,x),ps1:playerSprite(n,150,340,x),ps2:playerSprite(n,810,340,x,2),w:water(n,0,380,x),m:moon(n,800,100)};window.requestAnimationFrame(t),window.addEventListener("keydown",function(t){if("menu"===v.state)32===t.keyCode&&(v.state="intro");else if("toss"===v.state)t.keyCode===y.currentLetter?(d.keys[y.currentLetter-65].available=!0,y.assignLetter(d.getKey()),f.updateScore(10)):t.keyCode===u.currentLetter&&(d.keys[u.currentLetter-65].avaialble=!0,u.assignLetter(d.getKey()),p.updateScore(10));else if("attackIncoming"===v.state)t.keyCode===y.currentLetter?(d.keys[y.currentLetter-65].available=!0,y.assignLetter(d.getKey()),f.updateScore(20)):t.keyCode===u.currentLetter&&(d.keys[u.currentLetter-65].available=!0,u.assignLetter(d.getKey()),p.updateScore(20));else if("attackSelection"===v.state&&g.available)switch(t.keyCode){case 87:g.available=!1,v.state="attack",v.chosenAttack=T.water;break;case 70:g.available=!1,v.state="attack",v.chosenAttack=T.fire;break;case 69:g.available=!1,v.state="attack",v.chosenAttack=T.electric;break;case 83:g.available=!1,v.state="attack",v.chosenAttack=T.special}})}function moon(t,e,a){return{x:e,y:a,radius:40,draw:function(){t.fillStyle="rgb(255,255,255)",t.shadowColor="rgba(255,255,255,0.8)",t.shadowBlur=30,t.beginPath(),t.arc(this.x,this.y,this.radius,0,2*Math.PI,!0),t.closePath(),t.fill(),t.shadowBlur=0,t.fillStyle="rgb(0,0,0)",t.beginPath(),t.arc(this.x+10,this.y-10,this.radius,0,2*Math.PI,!0),t.closePath(),t.fill()}}}function attackBall(t,e,a,i,s,r){return{x:e,y:a,speed:s,player:r,radius:i,show:!1,colour:"rgb(255,255,255)",gradient:this.colour,setPlayer:function(t){this.player=t,this.x=1===this.player?180:780},setAttack:function(t){this.colour=t.colour,this.radius=t.damage},updateGradient:function(){this.gradient=t.createRadialGradient(this.x,this.y,5,this.x,this.y,.9*this.radius),this.gradient.addColorStop(0,"white"),this.gradient.addColorStop(1,this.colour)},draw:function(){this.show&&(this.updateGradient(),this.shadowColor=this.colour,this.shadowBlur=40,t.fillStyle=this.gradient,t.beginPath(),t.arc(this.x,this.y,this.radius,0,2*Math.PI,!0),t.closePath(),t.fill(),this.shadowBlur=0)},drawReflection:function(){this.show&&(t.fillStyle=this.gradient,t.shadowColor=this.colour,t.shadowBlur=30,t.beginPath(),t.arc(this.x,this.y+170,this.radius,0,2*Math.PI,!0),t.closePath(),t.fill(),t.shadowBlur=0)},update:function(){this.show&&(this.x+=1===this.player?this.speed:-1*this.speed)}}}function star(t,e,a){return{x:e,y:a,radius:rnd(1,3),draw:function(){t.fillStyle="rgb(255,255,255)",t.beginPath(),t.arc(this.x,this.y,this.radius,0,2*Math.PI,!0),t.closePath(),t.fill()}}}function starField(t,e){for(var a=[],i=0;e>i;i++){var s=rnd(0,960),r=rnd(0,540);a.push(star(t,s,r))}return a}function ground(t,e,a,i){var s=a;return{x:e,y:a+i,height:10,draw:function(){t.fillStyle="rgb(99,99,99)",t.fillRect(this.x,this.y,canvas.width,this.height)},reduceOffset:function(t){this.y<=s?this.y=s:this.y-=t}}}function water(t,e,a,i){var s=a;return{x:e,y:a+i,height:70,draw:function(){var e=t.createLinearGradient(canvas.width/2,this.y,canvas.width/2,this.y+this.height);e.addColorStop(0,"rgba(0,0,0,1)"),e.addColorStop(.5,"rgba(0,0,0,0.4)"),e.addColorStop(.6,"rgba(0,0,0,0.2)"),e.addColorStop(.65,"rgba(0,0,0,0.1)"),e.addColorStop(.7,"rgba(0,0,0,0.05)"),e.addColorStop(.75,"rgba(0,0,0,0)"),e.addColorStop(1,"rgba(0,0,0,0)"),t.fillStyle=e,t.rect(this.x,this.y,canvas.width,this.height),t.fill(),t.fillStyle="black"},reduceOffset:function(t){this.y<=s?this.y=s:this.y-=t}}}function playerSprite(t,e,a,i,s){var r=a,l=2===s?-1:1;return{x:e,y:a+i,health:100,draw:function(){var e=new Path2D;t.fillStyle="rgb(255,255,255)",t.shadowColor="white",t.shadowBlur=10,e.moveTo(this.x,this.y),e.lineTo(this.x-40*l,this.y),e.lineTo(this.x-10*l,this.y-100),e.lineTo(this.x+20*l,this.y-100),e.lineTo(this.x+30*l,this.y),e.moveTo(this.x-10*l,this.y),e.lineTo(this.x-12*l,this.y+30),e.lineTo(this.x-20*l,this.y+30),e.lineTo(this.x-18*l,this.y),e.moveTo(this.x+15*l,this.y),e.lineTo(this.x+15*l,this.y+30),e.lineTo(this.x+7*l,this.y+30),e.lineTo(this.x+7*l,this.y),t.fill(e),t.shadowBlur=0;var a=new Path2D;t.fillStyle="rgb(40,40,40)",a.moveTo(this.x+17*l,this.y-98),a.lineTo(this.x+19*l,this.y-75),a.lineTo(this.x+4*l,this.y-75),a.lineTo(this.x+9*l,this.y-98),t.fill(a)},drawReflection:function(){var e=new Path2D;t.fillStyle="rgba(255,255,255,"+this.health/100+")",t.shadowColor="rgba(255,255,255,"+this.health/100+")",t.shadowBlur=20;var a=this.y+60;e.moveTo(this.x,a),e.lineTo(this.x-40*l,a),e.lineTo(this.x-10*l,a+100),e.lineTo(this.x+20*l,a+100),e.lineTo(this.x+30*l,a),e.moveTo(this.x-10*l,a),e.lineTo(this.x-12*l,a-30),e.lineTo(this.x-20*l,a-30),e.lineTo(this.x-18*l,a),e.moveTo(this.x+15*l,a),e.lineTo(this.x+15*l,a-30),e.lineTo(this.x+7*l,a-30),e.lineTo(this.x+7*l,a),t.fill(e),t.shadowBlur=0;var i=new Path2D;t.fillStyle="rgba(40,40,40,"+this.health/100+")",i.moveTo(this.x+17*l,a+98),i.lineTo(this.x+19*l,a+75),i.lineTo(this.x+4*l,a+75),i.lineTo(this.x+9*l,a+98),t.fill(i)},reduceOffset:function(t){this.y<=r?this.y=r:this.y-=t}}}function rnd(t,e){return Math.floor(Math.random()*(e-t+1))+t}function KeyStroke(t){this.currentLetter=t}function AvailableKeys(){this.keys=[];for(var t=65;91>t;t++)this.keys.push({key:t,available:!0})}function Attack(t){this.ctx=t,this.available=!1}KeyStroke.prototype.assignLetter=function(t){this.currentLetter=t},KeyStroke.prototype.getLetter=function(){return String.fromCharCode(this.currentLetter).toUpperCase()},KeyStroke.prototype.getRandom=function(t,e){return Math.floor(Math.random()*(e-t+1))+t},AvailableKeys.prototype.getKey=function(){var t=rnd(0,this.keys.length-1),e=this.keys[t];return e.available?(this.keys[t].available=!1,e.key):this.getKey()},Attack.prototype.displayAttacks=function(t){this.available=!0,this.ctx.fillText("fire",t.x-100,t.y),this.ctx.fillText("water",t.x,t.y-100),this.ctx.fillText("electric",t.x+100,t.y),this.ctx.fillText("special",t.x,t.y+100)},Attack.prototype.selectedAttack=function(t){this.available&&(this.ctx.textAlign="left",this.ctx.fillText(t+" selected",20,100))};