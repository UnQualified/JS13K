function game(){function t(){if(e(),l(),O.ball.update(),h.fillStyle="black","menu"===b.state)r(o.toUpperCase(),c.x,c.y-50,"center","52px"),r("press [space]",c.x,c.y+20,"center");else if("intro"===b.state)r("INTRO",c.x,c.y+100,"center"),O.g.reduceOffset(v.fast),O.w.reduceOffset(v.fast),O.ps1.reduceOffset(v.fast),O.ps2.reduceOffset(v.fast),O.m.reduceOffset(v.med),O.stars.forEach(function(t){t.reduceOffset()}),O.ps1.scrollComplete&&(b.start=!0),b.start&&(b.state="toss");else if("toss"===b.state)if(p.getScore()<T&&g.getScore()<T)p.draw(h),g.draw(h);else{var a="";120>x?(x++,a=p.getScore()>=T?"player one":"player two",b.tossWinner=p.getScore()>=T?1:2,O.ball.setPlayer(b.tossWinner),a+=" has the power"):240>x?(a="choose your attack",x++):a=null,null!==a?r(a,c.x,c.y,"center"):b.state="attackSelection"}else if("attackSelection"==b.state)w.displayAttacks(c),i();else if("attack"==b.state){O.ball.setAttack(b.chosenAttack);var s="player "+b.tossWinner+" does a "+b.chosenAttack.type+" attack";r(s,c.x,c.y,"center"),x++,x>=120&&i({state:"defense"})}else if("defense"==b.state)b.defender=1===b.tossWinner?2:1,r("player "+b.defender+", reverse it!!",c.x,c.y,"center"),x++,x>=120&&i({state:"attackIncoming"});else if("attackIncoming"==b.state){x++;var d=60/b.chosenAttack.speed*10;switch(r(d+" : "+x,c.x,n.height-50,"center"),O.ball.speed=575/(d/10)/10,O.ball.show=!0,b.defender){case 1:p.draw(h),p.getScore()>=100&&(b.state="attackFail");break;case 2:g.draw(h),g.getScore()>=100&&(b.state="attackFail")}x>=d&&(b.state="attackSuccess")}else if("attackFail"==b.state)i(),O.ball.show=!1,1===b.defender?(b.playerTwoHealth-=b.chosenAttack.damage/2,O.ps2.health=b.playerTwoHealth,b.playerTwoHealth<=0?(b.playerTwoHealth=0,O.ps2.health=b.playerTwoHealth,i({state:"gameOver"})):b.state="toss"):(b.playerOneHealth-=b.chosenAttack.damage/2,O.ps1.health=b.playerOneHealth,b.playerOneHealth<=0?(b.playerOneHealth=0,O.ps1.health=b.playerOneHealth,b.state="gameOver"):b.state="toss");else if("attackSuccess"==b.state){O.ball.show=!1;var y=!0;1===b.defender?(b.playerOneHealth-=b.chosenAttack.damage,O.ps1.health=b.playerOneHealth,b.playerOneHealth<=0&&(b.playerOneHealth=0,O.ps1.health=b.playerOneHealth,b.state="gameOver",x=0,y=!1)):(b.playerTwoHealth-=b.chosenAttack.damage,O.ps2.health=b.playerTwoHealth,b.playerTwoHealth<=0&&(b.playerTwoHealth=0,O.ps2.health=b.playerTwoHealth,b.state="gameOver",x=0,y=!1)),y&&i({state:"toss"})}else if("gameOver"==b.state){var f=b.playerOneHealth<=0?"Player 2":"Player 1";f+=" wins",r(f,c.x,c.y,"center"),x++,x>=120&&(b.start=!1,i({state:"menu",health:!0}))}window.requestAnimationFrame(t)}function e(){h.clearRect(0,0,n.width,n.height)}function a(t,e,a){var s=0;return{draw:function(){h.lineWidth=3,h.strokeStyle="black",r(a.getLetter(),t,e,"center","400px","rgba(255,255,255,0.8)"),h.strokeText(a.getLetter(),t,e),h.lineWidth=0},getScore:function(){return s},updateScore:function(t){s+=t},resetScore:function(){s=0}}}function s(){return{x:n.width/2,y:n.height/2}}function i(t){x=0,p.resetScore(),g.resetScore(),void 0!==t&&(void 0!==t.health&&(b.playerOneHealth=b.playerTwoHealth=S),void 0!==t.state&&(b.state=t.state))}function r(t,e,a,s,i,r){void 0!==s&&(h.textAlign=s),void 0===r?(h.fillStyle="rgb(255,255,255)",h.shadowColor="white"):(h.fillStyle=r,h.shadowColor=r),h.font=(void 0===i?"22px":i)+" sans-serif",h.shadowBlur=10,h.fillText(t,e,a),h.shadowBlur=0}function l(){O.stars.forEach(function(t){t.draw()}),O.ball.draw(),O.ball.drawReflection(),O.m.draw(),O.g.draw(),O.ps1.draw(),O.ps1.drawReflection(),O.ps2.draw(),O.ps2.drawReflection(),O.w.draw()}var o="The Odul Mages",n=document.getElementById("canvas"),h=n.getContext("2d");n.width=960,n.height=540;var c=s(),d=new Sounds,y=new AvailableKeys,f=new KeyStroke(y.getKey()),u=new KeyStroke(y.getKey()),p=a(240,n.height/2+100,f),g=a(720,n.height/2+100,u),w=new Attack(h),x=0,k={yOffset:1.25*n.height,medYOffset:1.25*n.height*.1,slowYOffset:1.25*n.height*.05},v={fast:2,med:.2,slow:.1},b={state:"menu",attackingPlayer:null,playerOneHealth:100,playerTwoHealth:100,tossWinner:null,chosenAttack:null,defender:null,start:!1},S=100,T=50,m={water:{type:"water",speed:2,damage:30,colour:"rgb(0,0,255)"},fire:{type:"fire",speed:1,damage:40,colour:"rgb(255,0,0)"},electric:{type:"electric",speed:3,damage:15,colour:"rgb(255,255,0)"},special:{type:"special",speed:2,damage:50,colour:"rbg(255,0,255)"}},O={stars:starField(h,30,k,v),ball:attackBall(h,180,290,40,5,1),g:ground(h,0,370,k.yOffset),ps1:playerSprite(h,150,340,k.yOffset),ps2:playerSprite(h,810,340,k.yOffset,2),w:water(h,0,380,k.yOffset),m:moon(h,800,100,k.medYOffset)};window.requestAnimationFrame(t),window.addEventListener("keydown",function(t){if("menu"===b.state)32===t.keyCode&&(b.state="intro");else if("toss"===b.state)t.keyCode===f.currentLetter?(y.keys[f.currentLetter-65].available=!0,f.assignLetter(y.getKey()),p.updateScore(10),d.playSuccess(Math.round(p.getScore()/10-1))):t.keyCode===u.currentLetter&&(y.keys[u.currentLetter-65].avaialble=!0,u.assignLetter(y.getKey()),g.updateScore(10),d.playSuccess(Math.round(g.getScore()/10-1)));else if("attackIncoming"===b.state)t.keyCode===f.currentLetter?(y.keys[f.currentLetter-65].available=!0,f.assignLetter(y.getKey()),p.updateScore(20)):t.keyCode===u.currentLetter&&(y.keys[u.currentLetter-65].available=!0,u.assignLetter(y.getKey()),g.updateScore(20));else if("attackSelection"===b.state&&w.available)switch(t.keyCode){case 87:w.available=!1,b.state="attack",b.chosenAttack=m.water;break;case 70:w.available=!1,b.state="attack",b.chosenAttack=m.fire;break;case 69:w.available=!1,b.state="attack",b.chosenAttack=m.electric;break;case 83:w.available=!1,b.state="attack",b.chosenAttack=m.special}})}function moon(t,e,a,s){var i=a;return{x:e,y:a+s,radius:40,draw:function(){t.fillStyle="rgb(255,255,255)",t.shadowColor="rgba(255,255,255,0.8)",t.shadowBlur=30,t.beginPath(),t.arc(this.x,this.y,this.radius,0,2*Math.PI,!0),t.closePath(),t.fill(),t.shadowBlur=0,t.fillStyle="rgb(0,0,0)",t.beginPath(),t.arc(this.x+10,this.y-10,this.radius,0,2*Math.PI,!0),t.closePath(),t.fill()},reduceOffset:function(t){this.y<=i?this.y=i:this.y-=t}}}function attackBall(t,e,a,s,i,r){return{x:e,y:a,speed:i,player:r,radius:s,show:!1,colour:"rgb(255,255,255)",gradient:this.colour,setPlayer:function(t){this.player=t,this.x=1===this.player?180:780},setAttack:function(t){this.colour=t.colour,this.radius=t.damage},updateGradient:function(){this.gradient=t.createRadialGradient(this.x,this.y,5,this.x,this.y,.9*this.radius),this.gradient.addColorStop(0,"white"),this.gradient.addColorStop(1,this.colour)},draw:function(){this.show&&(this.updateGradient(),this.shadowColor=this.colour,this.shadowBlur=40,t.fillStyle=this.gradient,t.beginPath(),t.arc(this.x,this.y,this.radius,0,2*Math.PI,!0),t.closePath(),t.fill(),this.shadowBlur=0)},drawReflection:function(){this.show&&(t.fillStyle=this.gradient,t.shadowColor=this.colour,t.shadowBlur=30,t.beginPath(),t.arc(this.x,this.y+170,this.radius,0,2*Math.PI,!0),t.closePath(),t.fill(),t.shadowBlur=0)},update:function(){this.show&&(this.x+=1===this.player?this.speed:-1*this.speed)}}}function star(t,e,a,s,i){var r=a;return{x:e,y:a+s,radius:rnd(1,3),draw:function(){t.fillStyle="rgb(255,255,255)",t.beginPath(),t.arc(this.x,this.y,this.radius,0,2*Math.PI,!0),t.closePath(),t.fill()},reduceOffset:function(){this.y<=r?this.y=r:this.y-=i}}}function starField(t,e,a,s){for(var i=[],r=0;e>r;r++){var l=rnd(0,960),o=rnd(0,540),n=rnd(0,1),h={};1===n?(h.speed=s.med,h.offset=a.medYOffset):(h.speed=s.slow,h.offset=a.slowYOffset),i.push(star(t,l,o,h.offset,h.speed))}return i}function ground(t,e,a,s){var i=a;return{x:e,y:a+s,height:10,draw:function(){t.fillStyle="rgb(99,99,99)",t.fillRect(this.x,this.y,canvas.width,this.height)},reduceOffset:function(t){this.y<=i?this.y=i:this.y-=t}}}function water(t,e,a,s){var i=a;return{x:e,y:a+s,height:70,draw:function(){var e=t.createLinearGradient(canvas.width/2,this.y,canvas.width/2,this.y+this.height);e.addColorStop(0,"rgba(0,0,0,1)"),e.addColorStop(.5,"rgba(0,0,0,0.4)"),e.addColorStop(.6,"rgba(0,0,0,0.2)"),e.addColorStop(.65,"rgba(0,0,0,0.1)"),e.addColorStop(.7,"rgba(0,0,0,0.05)"),e.addColorStop(.75,"rgba(0,0,0,0)"),e.addColorStop(1,"rgba(0,0,0,0)"),t.fillStyle=e,t.rect(this.x,this.y,canvas.width,this.height),t.fill(),t.fillStyle="black"},reduceOffset:function(t){this.y<=i?this.y=i:this.y-=t}}}function playerSprite(t,e,a,s,i){var r=a,l=2===i?-1:1;return{x:e,y:a+s,health:100,scrollComplete:!1,draw:function(){var e=new Path2D;t.fillStyle="rgb(255,255,255)",t.shadowColor="white",t.shadowBlur=10,e.moveTo(this.x,this.y),e.lineTo(this.x-40*l,this.y),e.lineTo(this.x-10*l,this.y-100),e.lineTo(this.x+20*l,this.y-100),e.lineTo(this.x+30*l,this.y),e.moveTo(this.x-10*l,this.y),e.lineTo(this.x-12*l,this.y+30),e.lineTo(this.x-20*l,this.y+30),e.lineTo(this.x-18*l,this.y),e.moveTo(this.x+15*l,this.y),e.lineTo(this.x+15*l,this.y+30),e.lineTo(this.x+7*l,this.y+30),e.lineTo(this.x+7*l,this.y),t.fill(e),t.shadowBlur=0;var a=new Path2D;t.fillStyle="rgb(40,40,40)",a.moveTo(this.x+17*l,this.y-98),a.lineTo(this.x+19*l,this.y-75),a.lineTo(this.x+4*l,this.y-75),a.lineTo(this.x+9*l,this.y-98),t.fill(a)},drawReflection:function(){var e=new Path2D;t.fillStyle="rgba(255,255,255,"+this.health/100+")",t.shadowColor="rgba(255,255,255,"+this.health/100+")",t.shadowBlur=20;var a=this.y+70;e.moveTo(this.x,a),e.lineTo(this.x-40*l,a),e.lineTo(this.x-10*l,a+100),e.lineTo(this.x+20*l,a+100),e.lineTo(this.x+30*l,a),e.moveTo(this.x-10*l,a),e.lineTo(this.x-12*l,a-30),e.lineTo(this.x-20*l,a-30),e.lineTo(this.x-18*l,a),e.moveTo(this.x+15*l,a),e.lineTo(this.x+15*l,a-30),e.lineTo(this.x+7*l,a-30),e.lineTo(this.x+7*l,a),t.fill(e),t.shadowBlur=0;var s=new Path2D;t.fillStyle="rgba(40,40,40,"+this.health/100+")",s.moveTo(this.x+17*l,a+98),s.lineTo(this.x+19*l,a+75),s.lineTo(this.x+4*l,a+75),s.lineTo(this.x+9*l,a+98),t.fill(s)},reduceOffset:function(t){this.y<=r?(this.y=r,this.scrollComplete=!0):this.y-=t}}}function rnd(t,e){return Math.floor(Math.random()*(e-t+1))+t}function KeyStroke(t){this.currentLetter=t}function AvailableKeys(){this.keys=[];for(var t=65;91>t;t++)this.keys.push({key:t,available:!0})}function Attack(t){this.ctx=t,this.available=!1}function Sounds(){this.audioContext=new AudioContext,this.notes=[[-3,2,9],[0,5,12],[3,8,15],[6,11,18],[9,14,21]]}KeyStroke.prototype.assignLetter=function(t){this.currentLetter=t},KeyStroke.prototype.getLetter=function(){return String.fromCharCode(this.currentLetter).toUpperCase()},KeyStroke.prototype.getRandom=function(t,e){return Math.floor(Math.random()*(e-t+1))+t},AvailableKeys.prototype.getKey=function(){var t=rnd(0,this.keys.length-1),e=this.keys[t];return e.available?(this.keys[t].available=!1,e.key):this.getKey()},Attack.prototype.displayAttacks=function(t){this.available=!0,this.ctx.fillText("fire",t.x-100,t.y),this.ctx.fillText("water",t.x,t.y-100),this.ctx.fillText("electric",t.x+100,t.y),this.ctx.fillText("special",t.x,t.y+100)},Attack.prototype.selectedAttack=function(t){this.available&&(this.ctx.textAlign="left",this.ctx.fillText(t+" selected",20,100))},Sounds.prototype.playSuccess=function(t){for(var e=.05,a=0-e,s=.05,i=0;i<this.notes[t].length;i++)this.play(a+=e,this.notes[t][i],s)},Sounds.prototype.play=function(t,e,a){var s=this.audioContext.currentTime+t,i=this.audioContext.createGain(),r=this.audioContext.createGain(),l=this.audioContext.createDelay(),o=this.audioContext.createGain();o.connect(this.audioContext.destination),l.delayTime.value=.1,r.gain.value=.4,i.connect(o),i.connect(l),l.connect(r),r.connect(l),r.connect(o);var n=this.audioContext.createOscillator();n.connect(l),n.type="square",n.detune.value=100*e,n.start(s),n.stop(s+a)};