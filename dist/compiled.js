function game(){function e(){if(t(),n(u.state,l.width-200,20,"left"),n("player 1: "+u.playerOneHealth,10,l.height-50),n("player 2: "+u.playerTwoHealth,l.width-200,l.height-50),"toss"===u.state)if(d.getScore()<v&&k.getScore()<v)d.draw(c),k.draw(c);else{var a="";120>f?(f++,a=d.getScore()>=v?"player one":"player two",u.tossWinner=d.getScore()>=v?1:2,a+=" has the power"):240>f?(a="choose your attack",f++):a=null,null!==a?n(a,i.x,i.y,"center"):u.state="attackSelection"}else if("attackSelection"==u.state)p.displayAttacks(i),s();else if("attack"==u.state){var r="player "+u.tossWinner+" does a "+u.chosenAttack.type+" attack";n(r,i.x,i.y,"center"),f++,f>=120&&s({state:"defense"})}else if("defense"==u.state)u.defender=1===u.tossWinner?2:1,n("player "+u.defender+", reverse it!!",i.x,i.y,"center"),f++,f>=120&&s({state:"attackIncoming"});else if("attackIncoming"==u.state){f++;var o=60/u.chosenAttack.speed*10;switch(n(o+" : "+f,i.x,l.height-50,"center"),u.defender){case 1:d.draw(c),d.getScore()>=100&&(u.state="attackFail");break;case 2:k.draw(c),k.getScore()>=100&&(u.state="attackFail")}f>=o&&(u.state="attackSuccess")}else if("attackFail"==u.state)s(),1===u.defender?(u.playerTwoHealth-=u.chosenAttack.damage/2,u.playerTwoHealth<=0?(u.playerTwoHealth=0,s({state:"gameOver"})):u.state="toss"):(u.playerOneHealth-=u.chosenAttack.damage/2,u.playerOneHealth<=0?(u.playerOneHealth=0,u.state="gameOver"):u.state="toss");else if("attackSuccess"==u.state){var y=!0;1===u.defender?(u.playerOneHealth-=u.chosenAttack.damage,u.playerOneHealth<=0&&(u.playerOneHealth=0,u.state="gameOver",f=0,y=!1)):(u.playerTwoHealth-=u.chosenAttack.damage,u.playerTwoHealth<=0&&(u.playerTwoHealth=0,u.state="gameOver",f=0,y=!1)),y&&s({state:"toss"})}else if("gameOver"==u.state){var h=u.playerOneHealth<=0?"Player 2":"Player 1";h+=" wins",n(h,i.x,i.y,"center"),f++,f>=120&&s({state:"toss",health:!0})}window.requestAnimationFrame(e)}function t(){c.clearRect(0,0,l.width,l.height)}function a(e,t,a){var r=0;return c.font="22px sans-serif",{draw:function(){c.fillText(a.getLetter(),e,t),c.fillText(r,e,t+50)},getScore:function(){return r},updateScore:function(e){r+=e},resetScore:function(){r=0}}}function r(){return{x:l.width/2,y:l.height/2}}function s(e){f=0,d.resetScore(),k.resetScore(),void 0!==e&&(void 0!==e.health&&(u.playerOneHealth=u.playerTwoHealth=g),void 0!==e.state&&(u.state=e.state))}function n(e,t,a,r){void 0!==r&&(c.textAlign=r),c.fillText(e,t,a)}var l=document.getElementById("canvas"),c=l.getContext("2d");l.width=800,l.height=400;var i=r(),o=new AvailableKeys,y=new KeyStroke(o.getKey()),h=new KeyStroke(o.getKey()),d=a(10,20,y),k=a(100,20,h),p=new Attack(c),f=0,u={state:"toss",attackingPlayer:null,playerOneHealth:100,playerTwoHealth:100,tossWinner:null,chosenAttack:null,defender:null},g=100,v=10,w={water:{type:"water",speed:2,damage:30},fire:{type:"fire",speed:1,damage:40},electric:{type:"electric",speed:3,damage:15},special:{type:"special",speed:2,damage:50}};window.requestAnimationFrame(e),window.addEventListener("keydown",function(e){if("toss"===u.state)e.keyCode===y.currentLetter?(o.keys[y.currentLetter-65].available=!0,y.assignLetter(o.getKey()),d.updateScore(10)):e.keyCode===h.currentLetter&&(o.keys[h.currentLetter-65].avaialble=!0,h.assignLetter(o.getKey()),k.updateScore(10));else if("attackIncoming"===u.state)e.keyCode===y.currentLetter?(o.keys[y.currentLetter-65].available=!0,y.assignLetter(o.getKey()),d.updateScore(20)):e.keyCode===h.currentLetter&&(o.keys[h.currentLetter-65].available=!0,h.assignLetter(o.getKey()),k.updateScore(20));else if("attackSelection"===u.state&&p.available)switch(e.keyCode){case 87:p.available=!1,u.state="attack",u.chosenAttack=w.water;break;case 70:p.available=!1,u.state="attack",u.chosenAttack=w.fire;break;case 69:p.available=!1,u.state="attack",u.chosenAttack=w.electric;break;case 83:p.available=!1,u.state="attack",u.chosenAttack=w.special}})}function rnd(e,t){return Math.floor(Math.random()*(t-e+1))+e}function KeyStroke(e){this.currentLetter=e}function AvailableKeys(){this.keys=[];for(var e=65;91>e;e++)this.keys.push({key:e,available:!0})}function Attack(e){this.ctx=e,this.available=!1}KeyStroke.prototype.assignLetter=function(e){this.currentLetter=e},KeyStroke.prototype.getLetter=function(){return String.fromCharCode(this.currentLetter).toUpperCase()},KeyStroke.prototype.getRandom=function(e,t){return Math.floor(Math.random()*(t-e+1))+e},AvailableKeys.prototype.getKey=function(){var e=rnd(0,this.keys.length-1),t=this.keys[e];return t.available?(this.keys[e].available=!1,t.key):this.getKey()},Attack.prototype.displayAttacks=function(e){this.available=!0,this.ctx.fillText("fire",e.x-100,e.y),this.ctx.fillText("water",e.x,e.y-100),this.ctx.fillText("electric",e.x+100,e.y),this.ctx.fillText("special",e.x,e.y+100)},Attack.prototype.selectedAttack=function(e){this.available&&(this.ctx.textAlign="left",this.ctx.fillText(e+" selected",20,100))};